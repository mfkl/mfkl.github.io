<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Torrents and multimedia streaming with LibVLCSharp and MonoTorrent</title>
  <meta name="description" content="Torrents and multimedia streaming with LibVLCSharp and MonoTorrentThis post explores possibilities of torrenting and streaming technologies in .NET by combin...">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="https://mfkl.github.io/libvlc/2020/03/23/Torrents-and-multimedia-streaming.html">
  <link rel="alternate" type="application/rss+xml" title="mfkl" href="https://mfkl.github.io/feed.xml">
</head>


  <body>

    <header class="site-header">

  <div class="wrapper">

    <a class="site-title" href="/">mfkl</a>

    <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg viewBox="0 0 18 15">
          <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>

      <div class="trigger">
        
          
        
          
        
          
        
      </div>
    </nav>

  </div>

</header>


    <div class="page-content">
      <div class="wrapper">
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title" itemprop="name headline">Torrents and multimedia streaming with LibVLCSharp and MonoTorrent</h1>
    <p class="post-meta"><time datetime="2020-03-23T05:10:40+01:00" itemprop="datePublished">Mar 23, 2020</time></p>
  </header>

  <div class="post-content" itemprop="articleBody">
    <h3 id="torrents-and-multimedia-streaming-with-libvlcsharp-and-monotorrent">Torrents and multimedia streaming with LibVLCSharp and MonoTorrent</h3>

<p>This post explores possibilities of torrenting and streaming technologies in .NET by combining key features from several libraries to build a unique and fun CLI sample app. But first, some context.</p>

<h2 id="the-bittorrent-protocol">The BitTorrent protocol</h2>

<p>The BitTorrent protocol is a protocol used to share files between users over internet.</p>

<p>According to <a href="https://en.wikipedia.org/wiki/BitTorrent">Wikipedia</a>,</p>
<blockquote>
  <p>BitTorrent (abbreviated to BT) is a communication protocol for peer-to-peer file sharing (P2P) which is used to distribute data and electronic files over the Internet.</p>
</blockquote>

<blockquote>
  <p>BitTorrent is one of the most common protocols for transferring large files, such as digital video files containing TV shows or video clips or digital audio files containing songs. Peer-to-peer networks have been estimated to collectively account for approximately 43% to 70% of all Internet traffic (depending on location) as of February 2009. In February 2013, BitTorrent was responsible for 3.35% of all worldwide bandwidth, more than half of the 6% of total bandwidth dedicated to file sharing.</p>
</blockquote>

<p>Since the BitTorrent is so well suited to transfer large files (such as multimedia files), the idea of embedding it in mediaplayers like VLC has commonly been an area of interest for some time.</p>

<p align="center">
    <img src="/assets/file-sharing.png" />
</p>

<h2 id="popular-torrenting-libraries">Popular torrenting libraries</h2>

<p>A few words on torrenting libraries you can use in your code.</p>

<ul>
  <li>
    <p>The most popular BitTorrent protocol implementation is <a href="https://github.com/arvidn/libtorrent/">libtorrent</a>, written in C++. We will come back to it later in this blog post.</p>
  </li>
  <li>
    <p>Currently maintained by <a href="https://github.com/alanmcgovern">Alan McGovern</a>, <a href="https://github.com/alanmcgovern/monotorrent">MonoTorrent</a> seems to be the obvious choice for .NET. Do note that it is not merely a binding over <code class="highlighter-rouge">libtorrent</code> but a complete C# implementation of the BitTorrent protocol.</p>
  </li>
</ul>

<h2 id="torrenting-with-vlc">Torrenting with VLC</h2>

<p>Integrating torrent support for VLC is not a new idea, and there are several ways to go about it. Here are 2 possible approaches:</p>

<ol>
  <li>
    <p>Write a VLC plugin.</p>

    <p>Since VLC has been designed from early on with a plugin-based architecture, one could <a href="https://wiki.videolan.org/Hacker_Guide/How_To_Write_a_Module/">write a plugin</a> for it, usually using C/C++ or Rust.</p>

    <p>That is the approach that <a href="https://github.com/johang">Johan Gunnarsson</a> chose with <a href="https://github.com/johang/vlc-bittorrent">vlc-bittorrent</a>. <a href="https://github.com/johang/vlc-bittorrent">vlc-bittorrent</a> uses <a href="https://github.com/arvidn/libtorrent/">libtorrent</a>, the C++ BitTorrent implementation mentioned above and hooks into VLC at the plugin interface level.</p>

    <p>The VLC core would load the plugin and raise its callbacks.</p>

    <p>A downside of this approach is that you must build and link the native plugin for each platform you want to support.</p>
  </li>
  <li>
    <p>Use the LibVLC API.</p>

    <p>LibVLC is a higher level interface to access the VLC features. It abstracts away intricacies of the APIs to provide a simple yet powerful crossplatform API. This is what LibVLCSharp is based on and what I chose to use for this sample. To continue, let’s have a look at recent developments of MonoTorrent.</p>

    <p>In the pull request <a href="https://github.com/alanmcgovern/monotorrent/pull/271">271</a>, Alan introduced a new media streaming API:</p>

    <blockquote>
      <p>Added MonoTorrent.Streaming.StreamProvider.</p>
    </blockquote>

    <blockquote>
      <p>This class allows files in a torrent to be accessed using a readable and seekable Stream while the Torrent is still being downloaded. The Stream instance returned by StreamProvider.CreateStreamAsync uses a special PiecePicker so that it downloads data sequentially starting at the current Stream.Position.</p>
    </blockquote>

    <blockquote>
      <p>In other words - if you are streaming a video file you can seek to the middle of the file and MonoTorrent will immediately start downloading pieces from that point onwards…</p>
    </blockquote>

    <p>It sounds like exactly what we need to get torrenting working smoothly with LibVLCSharp. With this API, we can feed a <code class="highlighter-rouge">.torrent</code> file to MonoTorrent and get back a .NET <code class="highlighter-rouge">Stream</code>.</p>

    <p>This .NET <code class="highlighter-rouge">Stream</code> is representing the media content, which is being downloaded in real time from the BitTorrent network.</p>

    <p>On the LibVLC side, the <code class="highlighter-rouge">Media</code> type has a constructor which takes a .NET stream using the <a href="https://github.com/videolan/libvlcsharp/blob/3.x/LibVLCSharp/Shared/StreamMediaInput.cs">StreamMediaInput</a> type.</p>

    <p>With the .NET <code class="highlighter-rouge">Stream</code> from MonoTorrent, it is then possible to create a LibVLCSharp <code class="highlighter-rouge">Media</code> object and finally start the playback.</p>
  </li>
</ol>

<p align="center">
    <img src="/assets/lvst.gif" />
</p>
<p align="center">
    <i>LVST CLI app</i>
</p>

<p>This way we can watch the movie seamlessly as we download it onto the device using the BitTorrent protocol. And with MonoTorrent and LibVLCSharp both targeting .NET Standard, this works on pretty much <strong>all</strong> platforms.</p>

<h2 id="local-or-remote-playback">Local or remote playback</h2>

<h4 id="local">Local</h4>
<p>For local playback, we have a couple solutions.</p>
<ul>
  <li>By default, if running from a CLI app, the VLC engine will create a new Window that will be used for video output.</li>
  <li>We could use the crossplatform <a href="http://localhost:4000/libvlc/crossplatform/xamarin/forms/2019/08/13/MediaPlayerElement-Plug-and-play-LibVLCSharp-UI-video-control.html">MediaElement</a> control and combine it to this.</li>
  <li>Playing in any VLC app would also be possible by having this CLI app stream to the <code class="highlighter-rouge">localhost:port</code>, and play that stream in VLC.</li>
</ul>

<h4 id="remote">Remote</h4>

<p>But… VLC also supports chromecast, and so, <a href="https://mfkl.github.io/chromecast/2018/10/21/High-performance-cross-platform-streaming-with-libvlc-and-Chromecast-on-.NET.html">LibVLCSharp does too</a>.</p>

<blockquote>
  <p>Would it be possible to send the movie stream to the local chromecast while downloading it from the P2P network with MonoTorrent?</p>
</blockquote>

<p><strong>Yes</strong>, and VLC will also transcode the media in real time if the chromecast does not natively support it.</p>

<h2 id="lvst">LVST</h2>

<p><a href="https://github.com/mfkl/lvst">LVST</a> is a CLI .NET Core 3.1 app running on Linux, macOS and Windows. Xamarin support would be simple to add, but I wanted this to be a CLI sample.</p>

<p><a href="https://github.com/mfkl/lvst">LVST</a> is designed to be a basic sample and focused on the torrenting feature, there are currently no playback controls.</p>

<p>Just provide it with a <code class="highlighter-rouge">.torrent</code> file URL with <code class="highlighter-rouge">--torrent</code> and it will start to download and play it. Casting to the chromecast is as easy as giving it the <code class="highlighter-rouge">--cast</code> flag.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>.\LVST.exe --help
LVST 1.0.0
Copyright (C) 2020 LVST

  -v, --verbose    Set output to verbose messages.

  -t, --torrent    The torrent link to download and play

  -c, --cast       Cast to the chromecast

  -s, --save       Whether to save the media file. Defaults to true.

  -p, --path       Set the path where to save the media file.
</code></pre></div></div>

<p>Feel free to fork away if you’d like to play around with <a href="https://github.com/mfkl/lvst">LVST</a>.</p>

<h2 id="possible-improvements">Possible improvements</h2>

<p>What else could be done with regard to LibVLCSharp and MonoTorrent?</p>

<ul>
  <li>Make mobile samples</li>
  <li>In case of multiple chromecasts on the network, allow selecting one chromecast from the CLI.</li>
  <li>Integrate this with the MediaElement control.</li>
</ul>

<p>I am also considering making a <code class="highlighter-rouge">LibVLCSharp.MonoTorrent</code> package to make torrent support transparent in LibVLCSharp. Feel free to reach out if that is something you would like to see!</p>

  </div>

</article>

      </div>
    </div>

    <footer class="site-footer">

  <div class="wrapper">

    <h2 class="footer-heading">mfkl</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li>mfkl</li>
          <li><a href="mailto:"></a></li>
        </ul>
      </div>

      <div class="footer-col footer-col-2">
        <ul class="social-media-list">
          
          <li>
            <a href="https://github.com/mfkl"><span class="icon icon--github"><svg viewBox="0 0 16 16"><path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/></svg>
</span><span class="username">mfkl</span></a>

          </li>
          

          
          <li>
            <a href="https://twitter.com/martz2804"><span class="icon icon--twitter"><svg viewBox="0 0 16 16"><path fill="#828282" d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27 c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767 c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206 C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271 c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469 c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"/></svg>
</span><span class="username">martz2804</span></a>

          </li>
          
        </ul>
      </div>

      <div class="footer-col footer-col-3">
        <p></p>
      </div>
    </div>

  </div>

</footer>


  </body>

</html>
